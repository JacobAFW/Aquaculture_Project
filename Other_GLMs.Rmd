---
title: "ddPCR_model"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages 

```{r, warning=F, message=F, results='hide'}
sapply(c("lme4", "nlme", "dplyr", "plyr", "lmerTest", "aods3", 
         "tidyverse", "ggplot2", "MuMIn", "sjPlot", "gridExtra", 
         "grid", "car", "emmeans", "ggpubr", "DESeq2"), 
         require, character.only = TRUE)
```

# Mixed effects modelling with ddPCR

**Modelling Idea**
Try modelling simialr to the logistic model, but use ddPCR and a linear model instead.

## Data with DESeq2 normalised microbial counts
 - taxa are what was found to be significant using `phyloseq_to_deseq2(ps3.Microbiome, ~ parasite_burden)` with a Wald test.
```{r, warning=F, message=F}
glm_data <- subset_samples(ps3, Type == "Microbiome") %>% 
  sample_data() %>% 
  unclass() %>% 
  as.data.frame() %>% 
  mutate(ID = paste0("AM", ID)) %>% 
  mutate(ddPCR = as.factor(ddPCR)) %>% # convert to factor so that we don't centre and scale it
  left_join(
    (phyloseq_to_deseq2(ps3.Microbiome, ~ parasite_burden) %>% 
    calc_geo_means() %>% 
    counts(normalized = TRUE) %>%  
    as.data.frame() %>% 
    filter(rownames(.) == "TTTCGAATCATTCACAATGGGGGAAACCCTGATGGTGCAACGCCGCGTGGGGGATGAAGGCCTTCGGGTTGTAAACCTCTGTCACCAAGGAGCAACAAGCCGGTTCATAGCCGGCCCTGAGTTAACTTGGAGAGGAAGCAGTGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGACTGCAAGCGTTACTCGGATTCACTGGGCGTAAAGGGTGCGTAGGCCGCTAAGCGTGTCGGGTGTGAAATCTCGGGGCTCAACCTCGAAACTGCGCCCGAAACTGTTTAGCTAGAGTGTCGGAGAGGTAAGCGGAATTCCAGGTGTAGCGGTGAAATGCGTAGATATCTGGAGGAACACCAATGGCGAAGGCAGCTTACTGGACGACAACTGACGCTGAGGCACGAAAGCGTGGGTAGCGAAAGGG" | 
             rownames(.) ==  "TGAGGAATATTGGACAATGGACGAAAGTCTGATCCAGCCATGCCGCGTGCAGGATGACGGCCCTATGGGTTGTAAACTGCTTTTATACAGGAAGAAACACTCCCACGTGTGGGGGCTTGACGGTACTGTACGAATAAGGATCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGATCCAAGCGTTATCCGGAATTATTGGGTTTAAAGGGTCCGCAGGCGGTCTATTAAGTCAGAGGTGAAATCTTGCAGCTCAACTGTAAAATTGCCTTTGATACTGGTAGACTTGAGTCATTGTGAAGTGGTTAGAATGTGTGGTGTAGCGGTGAAATGCATAGATATCACACAGAATACCAATTGCGAAGGCAGATCACTAACAATGTACTGACGCTCATGGACGAAAGCGTGGGGAGCGAACAGG" | 
             rownames(.) == "TGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATATAGGAAGATAATGACGGTACTATATGAATAAGCGCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGCGCAAGCGTTACTCGGAATCACTGGGCGTAAAGAGCGTGTAGGCGGGTTAATAAGTTTGAAGTGAAATCCTATGGCTCAACCATAGAACTGCTTTGAAAACTGTTAACCTAGAATATGGGAGAGGTAGATGGAATTTCTGGTGTAGGGGTAAAATCCGTAGAGATCAGAAGGAATACCGATTGCGAAGGCGATCTACTGGAACATTATTGACGCTGAGACGCGAAAGCGTGGGGAGCAAACAGG" | 
             rownames(.) == "TGGGGAATCTTAGACAATGGGGGAAACCCTGATCTAGCCATGCCGCGTGAGTGACGAAGGCCTTAGGGTCGTAAAGCTCTTTCGCTGGGGAAGATAATGACTGTACCCAGTAAAGAAACCCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCGCGTAGGCGGACTGGAAAGTTGGGGGTGAAATCCCGGGGCTCAACCCCGGAACGGCCTCCAAAACTATCAGTCTAGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGCGTGGGGAGCAAACAGG" | 
             rownames(.) == "TGAGGAATATTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGCAGGAAGAATGCCCTATGGGTTGTAAACTGCTTTTATTTGGGAATAAACCTCCTTACGTGTAGGGAGCTGAATGTACCAAACGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGCAGGCGGGCCTATAAGTCAGTGGTGAAATCCCATCGCTTAACGATGGAACTGCCATTGATACTGTAGGTCTTGAATTCGGTCGAAGTGGGCGGAATGTGTCATGTAGCGGTGAAATGCATAGATATGACACAGAACACCGATAGCGAAGGCAGCTCACTAGGCCTGGATTGACGCTCAGGGACGAAAGCGTGGGGAGCGAACAGG") %>% 
  base::t() %>% 
  as.data.frame() %>% 
  dplyr::rename("Coraliomargarita" = "TTTCGAATCATTCACAATGGGGGAAACCCTGATGGTGCAACGCCGCGTGGGGGATGAAGGCCTTCGGGTTGTAAACCTCTGTCACCAAGGAGCAACAAGCCGGTTCATAGCCGGCCCTGAGTTAACTTGGAGAGGAAGCAGTGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGACTGCAAGCGTTACTCGGATTCACTGGGCGTAAAGGGTGCGTAGGCCGCTAAGCGTGTCGGGTGTGAAATCTCGGGGCTCAACCTCGAAACTGCGCCCGAAACTGTTTAGCTAGAGTGTCGGAGAGGTAAGCGGAATTCCAGGTGTAGCGGTGAAATGCGTAGATATCTGGAGGAACACCAATGGCGAAGGCAGCTTACTGGACGACAACTGACGCTGAGGCACGAAAGCGTGGGTAGCGAAAGGG",  
         "NS4_marine_group" = "TGAGGAATATTGGACAATGGACGAAAGTCTGATCCAGCCATGCCGCGTGCAGGATGACGGCCCTATGGGTTGTAAACTGCTTTTATACAGGAAGAAACACTCCCACGTGTGGGGGCTTGACGGTACTGTACGAATAAGGATCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGATCCAAGCGTTATCCGGAATTATTGGGTTTAAAGGGTCCGCAGGCGGTCTATTAAGTCAGAGGTGAAATCTTGCAGCTCAACTGTAAAATTGCCTTTGATACTGGTAGACTTGAGTCATTGTGAAGTGGTTAGAATGTGTGGTGTAGCGGTGAAATGCATAGATATCACACAGAATACCAATTGCGAAGGCAGATCACTAACAATGTACTGACGCTCATGGACGAAAGCGTGGGGAGCGAACAGG",
         "Acrobacter" = "TGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATATAGGAAGATAATGACGGTACTATATGAATAAGCGCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGCGCAAGCGTTACTCGGAATCACTGGGCGTAAAGAGCGTGTAGGCGGGTTAATAAGTTTGAAGTGAAATCCTATGGCTCAACCATAGAACTGCTTTGAAAACTGTTAACCTAGAATATGGGAGAGGTAGATGGAATTTCTGGTGTAGGGGTAAAATCCGTAGAGATCAGAAGGAATACCGATTGCGAAGGCGATCTACTGGAACATTATTGACGCTGAGACGCGAAAGCGTGGGGAGCAAACAGG", 
         "Marivivens" = "TGGGGAATCTTAGACAATGGGGGAAACCCTGATCTAGCCATGCCGCGTGAGTGACGAAGGCCTTAGGGTCGTAAAGCTCTTTCGCTGGGGAAGATAATGACTGTACCCAGTAAAGAAACCCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCGCGTAGGCGGACTGGAAAGTTGGGGGTGAAATCCCGGGGCTCAACCCCGGAACGGCCTCCAAAACTATCAGTCTAGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGCGTGGGGAGCAAACAGG", 
         "Salinirepens" = "TGAGGAATATTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGCAGGAAGAATGCCCTATGGGTTGTAAACTGCTTTTATTTGGGAATAAACCTCCTTACGTGTAGGGAGCTGAATGTACCAAACGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGCAGGCGGGCCTATAAGTCAGTGGTGAAATCCCATCGCTTAACGATGGAACTGCCATTGATACTGTAGGTCTTGAATTCGGTCGAAGTGGGCGGAATGTGTCATGTAGCGGTGAAATGCATAGATATGACACAGAACACCGATAGCGAAGGCAGCTCACTAGGCCTGGATTGACGCTCAGGGACGAAAGCGTGGGGAGCGAACAGG") %>% 
  rownames_to_column(var = "ID")), by = "ID") %>% 
  centre_and_scale() %>% # centre and scale all numeric variables
  mutate(ddPCR = as.numeric(ddPCR)) # convert ddPCR back to a numeric variable
```

```{r, warning=F, message=F}
glm_data %>% 
  ggplot() +
  geom_histogram(aes(x = ddPCR)) +
  scale_x_log10()
```

## Test for collinearity
 - this will differ slightly then the one for DESeq2 as turbidity was removed the DESeq2 test due to a lack of significant findings when conducting univariate analysis.
```{r, warning=F, message=F}
# full 
glm_data %>% 
  select(Temperature_C, pH, Turbidity_NTU, RDO_Conc_mgL, ORP_mV, RainGauge_mm, Salinity_PSU, NS4_marine_group, Salinirepens, Marivivens, Coraliomargarita, Acrobacter) %>% 
  corvif()

# final model
glm_data %>% 
  select(Turbidity_NTU, ORP_mV, RainGauge_mm, Salinity_PSU, NS4_marine_group, Coraliomargarita, Acrobacter) %>% 
  corvif()
```

### Try a few models
As we have a continuous non-negative dependent, but not linear then Gamma might be best. However, we can try a few and use both the gof, R2 and AIC to compare the models.

### Gaussian Model

```{r, warning=F, message=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = glm_data) 

summary(global)
gof(global)
r.squaredGLMM(global)
```

**Overdispersed, poor fit.**

### Poisson Model
 
```{r, , warning=F, message=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = glm_data, family = "poisson") 

summary(global)
gof(global)
r.squaredGLMM(global)
```

**Overdispersed, good fit.**

## Gamma Model
 
```{r, , warning=F, message=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = glm_data, family = Gamma(link = "log")) 

summary(global)
gof(global)
r.squaredGLMM(global)
```

**Not overdispersed, poor fit.**

**No good option. However, as the Gamma model is the only one not to be overdispersed we can go with that and use backwards selection to get the least complex adequate model and see if the R2 improves.**

### Backwards selection with full gamma model and full dataset.

```{r, warning=F, message=F}
dfun <- function(x) {
  x$AIC <- x$AIC-min(x$AIC)
  names(x)[2] <- "dAIC"
  x
}

dfun(drop1(global))
```

**Final Model.**

```{r, warning=F, message=F}
global2 <-lme4::glmer(ddPCR ~ Turbidity_NTU + (1|Date), data = glm_data, family = Gamma(link = "log")) 

dfun(drop1(global2))
```

```{r, warning=F, message=F}
summary(global2)
gof(global2)
r.squaredGLMM(global2)
```
**We end up removing most of the variables and still end up with a poor R2.**

### Plot the relationship
```{r, warning=F, message=F}
subset_samples(ps3, Type == "Microbiome") %>% 
  sample_data() %>% 
  unclass() %>% 
  as.data.frame() %>% 
  ggplot(aes(x = ddPCR, y = Turbidity_NTU)) + 
  geom_point() +
  scale_x_log10()
```


## Model with "influential data points" removed
```{r, warning=F, message=F}
# Plot cooks distances
global %>% 
  cooks.distance() %>% 
  plot(ylim = c(0, 10)) %>% 
  abline(h = 4/nrow(glm_data), lty = 2, col = "steelblue")

# Identify influential points
cooksD <- cooks.distance(global)

influential_obs <- as.numeric(names(cooksD)[(cooksD > (4/nrow(glm_data)))])

# Define new data frame with influential points removed
outliers_removed <- glm_data[-influential_obs, ]

# Create new model with outliers removed
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = outliers_removed, family = Gamma(link = "log"))

summary(global)
gof(global)
r.squaredGLMM(global)
```
**No overdispersion and R2 isn't great. May be underdispersed.**

### Backwards selection with gamma model and partial dataset.
```{r, warning=F, message=F}
dfun(drop1(global))
```

```{r, warning=F, message=F}
global2 <- lme4::glmer(ddPCR ~ Turbidity_NTU + Coraliomargarita + Acrobacter + (1|Date), data = outliers_removed, family = Gamma(link = "log"))

dfun(drop1(global2))
```

```{r, warning=F, message=F}
summary(global2)
gof(global2)
r.squaredGLMM(global2)
```
**R2 actually got worst.**



# Mixed effects modelling with summarised data

**Modelling Idea**
Try modelling the averages of the days instead of individual samples

```{r, warning=F, message=F}
summary_data <- subset_samples(ps3, Type == "Microbiome") %>% 
  sample_data() %>% 
  unclass() %>% 
  as.data.frame() %>% 
  mutate(ID = paste0("AM", ID)) %>% 
  mutate(ddPCR = as.factor(ddPCR)) %>% # convert to factor so that we don't centre and scale it
  left_join(
    (phyloseq_to_deseq2(ps3.Microbiome, ~ parasite_burden) %>% 
    calc_geo_means() %>% 
    counts(normalized = TRUE) %>%  
    as.data.frame() %>% 
    filter(rownames(.) == "TTTCGAATCATTCACAATGGGGGAAACCCTGATGGTGCAACGCCGCGTGGGGGATGAAGGCCTTCGGGTTGTAAACCTCTGTCACCAAGGAGCAACAAGCCGGTTCATAGCCGGCCCTGAGTTAACTTGGAGAGGAAGCAGTGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGACTGCAAGCGTTACTCGGATTCACTGGGCGTAAAGGGTGCGTAGGCCGCTAAGCGTGTCGGGTGTGAAATCTCGGGGCTCAACCTCGAAACTGCGCCCGAAACTGTTTAGCTAGAGTGTCGGAGAGGTAAGCGGAATTCCAGGTGTAGCGGTGAAATGCGTAGATATCTGGAGGAACACCAATGGCGAAGGCAGCTTACTGGACGACAACTGACGCTGAGGCACGAAAGCGTGGGTAGCGAAAGGG" | 
             rownames(.) ==  "TGAGGAATATTGGACAATGGACGAAAGTCTGATCCAGCCATGCCGCGTGCAGGATGACGGCCCTATGGGTTGTAAACTGCTTTTATACAGGAAGAAACACTCCCACGTGTGGGGGCTTGACGGTACTGTACGAATAAGGATCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGATCCAAGCGTTATCCGGAATTATTGGGTTTAAAGGGTCCGCAGGCGGTCTATTAAGTCAGAGGTGAAATCTTGCAGCTCAACTGTAAAATTGCCTTTGATACTGGTAGACTTGAGTCATTGTGAAGTGGTTAGAATGTGTGGTGTAGCGGTGAAATGCATAGATATCACACAGAATACCAATTGCGAAGGCAGATCACTAACAATGTACTGACGCTCATGGACGAAAGCGTGGGGAGCGAACAGG" | 
             rownames(.) == "TGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATATAGGAAGATAATGACGGTACTATATGAATAAGCGCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGCGCAAGCGTTACTCGGAATCACTGGGCGTAAAGAGCGTGTAGGCGGGTTAATAAGTTTGAAGTGAAATCCTATGGCTCAACCATAGAACTGCTTTGAAAACTGTTAACCTAGAATATGGGAGAGGTAGATGGAATTTCTGGTGTAGGGGTAAAATCCGTAGAGATCAGAAGGAATACCGATTGCGAAGGCGATCTACTGGAACATTATTGACGCTGAGACGCGAAAGCGTGGGGAGCAAACAGG" | 
             rownames(.) == "TGGGGAATCTTAGACAATGGGGGAAACCCTGATCTAGCCATGCCGCGTGAGTGACGAAGGCCTTAGGGTCGTAAAGCTCTTTCGCTGGGGAAGATAATGACTGTACCCAGTAAAGAAACCCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCGCGTAGGCGGACTGGAAAGTTGGGGGTGAAATCCCGGGGCTCAACCCCGGAACGGCCTCCAAAACTATCAGTCTAGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGCGTGGGGAGCAAACAGG" | 
             rownames(.) == "TGAGGAATATTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGCAGGAAGAATGCCCTATGGGTTGTAAACTGCTTTTATTTGGGAATAAACCTCCTTACGTGTAGGGAGCTGAATGTACCAAACGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGCAGGCGGGCCTATAAGTCAGTGGTGAAATCCCATCGCTTAACGATGGAACTGCCATTGATACTGTAGGTCTTGAATTCGGTCGAAGTGGGCGGAATGTGTCATGTAGCGGTGAAATGCATAGATATGACACAGAACACCGATAGCGAAGGCAGCTCACTAGGCCTGGATTGACGCTCAGGGACGAAAGCGTGGGGAGCGAACAGG") %>% 
  base::t() %>% 
  as.data.frame() %>% 
  dplyr::rename("Coraliomargarita" = "TTTCGAATCATTCACAATGGGGGAAACCCTGATGGTGCAACGCCGCGTGGGGGATGAAGGCCTTCGGGTTGTAAACCTCTGTCACCAAGGAGCAACAAGCCGGTTCATAGCCGGCCCTGAGTTAACTTGGAGAGGAAGCAGTGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGACTGCAAGCGTTACTCGGATTCACTGGGCGTAAAGGGTGCGTAGGCCGCTAAGCGTGTCGGGTGTGAAATCTCGGGGCTCAACCTCGAAACTGCGCCCGAAACTGTTTAGCTAGAGTGTCGGAGAGGTAAGCGGAATTCCAGGTGTAGCGGTGAAATGCGTAGATATCTGGAGGAACACCAATGGCGAAGGCAGCTTACTGGACGACAACTGACGCTGAGGCACGAAAGCGTGGGTAGCGAAAGGG",  
         "NS4_marine_group" = "TGAGGAATATTGGACAATGGACGAAAGTCTGATCCAGCCATGCCGCGTGCAGGATGACGGCCCTATGGGTTGTAAACTGCTTTTATACAGGAAGAAACACTCCCACGTGTGGGGGCTTGACGGTACTGTACGAATAAGGATCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGATCCAAGCGTTATCCGGAATTATTGGGTTTAAAGGGTCCGCAGGCGGTCTATTAAGTCAGAGGTGAAATCTTGCAGCTCAACTGTAAAATTGCCTTTGATACTGGTAGACTTGAGTCATTGTGAAGTGGTTAGAATGTGTGGTGTAGCGGTGAAATGCATAGATATCACACAGAATACCAATTGCGAAGGCAGATCACTAACAATGTACTGACGCTCATGGACGAAAGCGTGGGGAGCGAACAGG",
         "Acrobacter" = "TGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATATAGGAAGATAATGACGGTACTATATGAATAAGCGCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGCGCAAGCGTTACTCGGAATCACTGGGCGTAAAGAGCGTGTAGGCGGGTTAATAAGTTTGAAGTGAAATCCTATGGCTCAACCATAGAACTGCTTTGAAAACTGTTAACCTAGAATATGGGAGAGGTAGATGGAATTTCTGGTGTAGGGGTAAAATCCGTAGAGATCAGAAGGAATACCGATTGCGAAGGCGATCTACTGGAACATTATTGACGCTGAGACGCGAAAGCGTGGGGAGCAAACAGG", 
         "Marivivens" = "TGGGGAATCTTAGACAATGGGGGAAACCCTGATCTAGCCATGCCGCGTGAGTGACGAAGGCCTTAGGGTCGTAAAGCTCTTTCGCTGGGGAAGATAATGACTGTACCCAGTAAAGAAACCCCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGGGTTAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCGCGTAGGCGGACTGGAAAGTTGGGGGTGAAATCCCGGGGCTCAACCCCGGAACGGCCTCCAAAACTATCAGTCTAGAGTTCGAGAGAGGTGAGTGGAATTCCGAGTGTAGAGGTGAAATTCGTAGATATTCGGAGGAACACCAGTGGCGAAGGCGGCTCACTGGCTCGATACTGACGCTGAGGTGCGAAAGCGTGGGGAGCAAACAGG", 
         "Salinirepens" = "TGAGGAATATTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGCAGGAAGAATGCCCTATGGGTTGTAAACTGCTTTTATTTGGGAATAAACCTCCTTACGTGTAGGGAGCTGAATGTACCAAACGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGCAGGCGGGCCTATAAGTCAGTGGTGAAATCCCATCGCTTAACGATGGAACTGCCATTGATACTGTAGGTCTTGAATTCGGTCGAAGTGGGCGGAATGTGTCATGTAGCGGTGAAATGCATAGATATGACACAGAACACCGATAGCGAAGGCAGCTCACTAGGCCTGGATTGACGCTCAGGGACGAAAGCGTGGGGAGCGAACAGG") %>% 
  rownames_to_column(var = "ID")), by = "ID") %>% 
  centre_and_scale() %>% # centre and scale all numeric variables
  mutate(ddPCR = as.numeric(ddPCR)) %>% # convert ddPCR back to a numeric variable
  group_by(Date) %>% 
  summarise_if(is.numeric, mean) %>% 
  mutate(parasite_burden = ifelse( ddPCR > mean(ddPCR), "High", "Low")) %>% 
  mutate(parasite_burden = as.factor(parasite_burden))
```

## Logisitc - high vs low

## Fit Model

```{r, warning=F, message=F, results='hide'}
global <- lme4::glmer(parasite_burden ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = summary_data, family = "binomial") 

summary(global)
```

### R2 and gof

 - Calculate the goodness of fit and R2 to check for overdispertion and see how well the data models.
 - **Calculate these again post bakwards selection to see if backwards selection made improvements.**
 
```{r, warning=F, message=F}
gof(global)
r.squaredGLMM(global)
```

```{r, message=F, warning=F}
global4 <- lme4::glmer(parasite_burden ~ RainGauge_mm + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = summary_data, family = "binomial")
summary(global4)
gof(global4)
r.squaredGLMM(global4)
```
**R2 actually gets wort.**

**No statistical power, and we may be violating the minimum n requirement.**


## Linear - ddPCR

### Try a few families

### Gaussian Model

```{r, warning=F, message=F, eval=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = summary_data) 
```


### Poisson Model
 
```{r, , warning=F, message=F, eval=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = summary_data, family = "poisson") 

summary(global)
gof(global)
r.squaredGLMM(global)
```


## Gamma Model
 
```{r, , warning=F, message=F, eval=F}
global <- lme4::glmer(ddPCR ~ Turbidity_NTU + ORP_mV + RainGauge_mm + Salinity_PSU + NS4_marine_group + Coraliomargarita + Acrobacter + (1|Date), data = summary_data, family = Gamma(link = "log")) 

summary(global)
gof(global)
r.squaredGLMM(global)
```





